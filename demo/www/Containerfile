# /www/Containerfile
# The build context is the 'demo' directory.

# =================================================================
# STAGE 1: Base Image
# =================================================================
FROM oven/bun:1.2.19-slim AS base
LABEL project="pfp2e-demo" stage="base"
WORKDIR /app/www

# =================================================================
# STAGE 2: Dependencies
# This stage installs all dependencies needed for building.
# =================================================================
FROM base AS deps
LABEL project="pfp2e-demo" stage="deps"
COPY www/package.json www/bun.lock www/bunfig.toml ./
RUN bun install --frozen-lockfile

# =================================================================
# STAGE 3: Builder
# This stage builds the application.
# =================================================================
FROM deps AS builder
LABEL project="pfp2e-demo" stage="builder"
COPY www ./
RUN bun run build

# =================================================================
# STAGE 4: Final Production Image (Simplified)
# This image runs the app using a standard `bun run start`.
# =================================================================
FROM base AS prod-server
LABEL project="pfp2e-demo" stage="prod-server"
WORKDIR /app/www
ENV NODE_ENV=production
# Install curl for a reliable healthcheck
USER root
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
USER bun
# Copy dependencies and build artifacts
COPY --chown=bun:bun --from=deps /app/www/node_modules ./node_modules
COPY --chown=bun:bun --from=builder /app/www/.next ./.next
COPY --chown=bun:bun --from=builder /app/www/public ./public
COPY --chown=bun:bun --from=builder /app/www/package.json .
EXPOSE 3000
HEALTHCHECK --interval=5s --timeout=5s --start-period=5s --retries=3 CMD curl -f http://localhost:3000/ || exit 1
# Use the standard Next.js start script from package.json
CMD ["bun", "run", "start"]

# =================================================================
# STAGE 5: Final Test Runner Image
# =================================================================
FROM mcr.microsoft.com/playwright:v1.53.1-noble AS test-runner
LABEL project="pfp2e-demo" stage="test-runner"
WORKDIR /app/www
# Copy bun executable from the base stage
COPY --from=base /usr/local/bin/bun /usr/local/bin/bun
# Copy dependencies from our deps stage
COPY --from=deps /app/www/node_modules ./node_modules
# Copy test-related files from the 'www' subdir of the context
COPY www/package.json www/bun.lock ./
COPY www/playwright.config.ts .
COPY www/tsconfig.json .
COPY www/tests-ui ./tests-ui
# The test command is run from compose against the prod service.
CMD ["bun", "run", "test:ui"]